# 專案重構與解耦待辦事項清單

本待辦事項清單基於「專案耦合問題分析與改善建議報告」中的建議，旨在指導您逐步重構和解耦現有專案。

## 階段一：基礎重構與配置管理 (相對簡單)

### 1. 統一數據庫連接管理

- [ ] **任務 1.1：評估現有數據庫連接方式**
    - [ ] 盤點 `utils/db.js`, `utils/db2.js`, `app.js` 及各路由文件中所有數據庫連接的實例。
    - [ ] 分析每種連接方式的優缺點和使用場景。
- [ ] **任務 1.2：設計並實施統一的數據庫連接模塊**
    - [ ] 選擇一種統一的連接策略 (例如，基於 `utils/db2.js` 的改進版，或實現一個新的 `utils/database.js`)。
    - [ ] 確保新模塊能處理連接建立、獲取數據庫實例及應用程序關閉時的連接釋放。
    - [ ] (可選) 研究並實現數據庫連接池以優化性能。
- [ ] **任務 1.3：遷移現有代碼以使用新連接模塊**
    - [ ] 逐步修改 `app.js`，移除其內部的數據庫連接邏輯。
    - [ ] 逐步修改所有路由文件，使其調用新的統一數據庫連接模塊。
    - [ ] 刪除舊的、冗餘的數據庫連接文件 (如 `utils/db.js`，如果 `utils/db2.js` 未被採納也一併刪除)。
- [ ] **任務 1.4：測試數據庫連接的穩定性和功能**
    - [ ] 確保所有依賴數據庫的功能在修改後仍能正常工作。

### 2. 外部化硬編碼的配置

- [ ] **任務 2.1：識別所有硬編碼的配置項**
    - [ ] 查找代碼中所有硬編碼的數據庫 URI。
    - [ ] 查找代碼中所有硬編碼的 API 密鑰 (如 LINE Bot `accessToken`)。
    - [ ] 查找其他可能需要根據環境變化的配置項 (如端口號、服務 URL 等)。
- [ ] **任務 2.2：選擇並實施配置管理方案**
    - [ ] 推薦使用 `.env` 文件配合 `dotenv` 庫進行環境變量管理。
    - [ ] 創建 `.env.example` 文件作為配置模板。
    - [ ] 將 `.env` 文件添加到 `.gitignore` 以避免提交敏感信息。
- [ ] **任務 2.3：更新代碼以從配置中讀取**
    - [ ] 修改數據庫連接模塊，使其從環境變量讀取數據庫 URI。
    - [ ] 修改使用 LINE Bot `accessToken` 的地方，使其從環境變量讀取。
    - [ ] 確保應用程序啟動時能正確加載配置。
- [ ] **任務 2.4：測試不同環境下的配置加載**
    - [ ] 模擬不同環境配置，驗證應用程序行為是否符合預期。

## 階段二：代碼重用與職責分離 (中等複雜度)

### 3. 消除路由中的代碼重複

- [ ] **任務 3.1：分析 `routes/managePrescriptions.js` 和 `routes/managePrescriptions2.js`**
    - [ ] 詳細比較兩個文件，列出所有相同或高度相似的邏輯塊。
    - [ ] 識別它們之間真正的差異點 (如渲染的模板、排序邏輯)。
- [ ] **任務 3.2：提取公共邏輯到輔助函數或服務**
    - [ ] 創建一個新的輔助模塊 (例如 `utils/prescriptionHelper.js` 或 `services/prescriptionService.js` 的一部分) 來存放公共函數。
    - [ ] 將數據庫查詢、數據格式化、更新 `prei` 狀態、發送 LINE 通知的邏輯提取為可重用函數。
    - [ ] 考慮將 LINE Bot 消息體 (`bubbleMessage`) 的構建邏輯也提取出來。
- [ ] **任務 3.3：重構路由文件以調用公共邏輯**
    - [ ] 修改 `managePrescriptions.js` 和 `managePrescriptions2.js`，使其調用提取出的公共函數。
    - [ ] 通過參數傳遞差異化的部分 (如排序選項、視圖名稱)。
- [ ] **任務 3.4：(可選) 考慮合併相似路由**
    - [ ] 評估是否可以將 `managePrescriptions.js` 和 `managePrescriptions2.js` 合併為一個路由，通過查詢參數控制不同行為。
- [ ] **任務 3.5：測試重構後的路由功能**
    - [ ] 確保所有相關功能在重構後表現一致。

### 4. 分離 `app.js` 中的數據庫操作邏輯

- [ ] **任務 4.1：識別 `app.js` 中的數據庫操作**
    - [ ] 定位 `/delete/:id` 路由處理器中的數據庫刪除邏輯。
- [ ] **任務 4.2：將刪除邏輯遷移到合適的模塊**
    - [ ] 考慮將此刪除邏輯移至一個專門的處方管理路由文件或服務中。
    - [ ] 確保遷移後的邏輯也使用統一的數據庫連接模塊。
- [ ] **任務 4.3：更新 `app.js` 以移除直接的數據庫操作**
    - [ ] `app.js` 應主要負責應用初始化、中間件加載和路由註冊。
- [ ] **任務 4.4：測試刪除功能的正確性**

## 階段三：架構演進與進階優化 (相對複雜)

### 5. 分離業務邏輯與數據訪問層 (引入服務層和數據庫訪問層)

- [ ] **任務 5.1：規劃服務層 (Service Layer) 和數據訪問層 (DAL/Repository)**
    - [ ] 定義各層的職責邊界。
    - [ ] 規劃需要創建的 Repository (如 `prescriptionRepository.js`, `patientRepository.js`)。
    - [ ] 規劃需要創建的 Service (如 `prescriptionService.js`, `patientService.js`, `lineNotificationService.js`)。
- [ ] **任務 5.2：實現數據訪問層 (Repositories)**
    - [ ] 為每個主要數據實體創建 Repository 文件。
    - [ ] 封裝所有與該實體相關的數據庫 CRUD 操作 (創建、讀取、更新、刪除)。
    - [ ] Repository 應依賴統一的數據庫連接模塊。
- [ ] **任務 5.3：實現服務層 (Services)**
    - [ ] 創建服務文件，實現核心業務邏輯。
    - [ ] Service 層調用 Repository 進行數據操作，不直接與數據庫交互。
    - [ ] Service 層處理數據轉換、業務規則驗證、協調多個 Repository 操作等。
- [ ] **任務 5.4：重構路由處理器以使用服務層**
    - [ ] 修改所有路由文件，使其調用相應的 Service 方法。
    - [ ] 路由處理器應保持輕量，主要負責請求解析、調用服務、響應構建。
- [ ] **任務 5.5：全面測試分層後的應用功能**
    - [ ] 確保所有業務流程在新的分層架構下正常工作。

### 6. 其他潛在改進點實施

- [ ] **任務 6.1：增強錯誤處理機制**
    - [ ] 設計並實現統一的錯誤處理中間件。
    - [ ] (可選) 定義自定義錯誤類以更好地區分不同錯誤類型。
    - [ ] 確保向客戶端返回更友好和一致的錯誤信息。
- [ ] **任務 6.2：實施輸入驗證**
    - [ ] 選擇一個驗證庫 (如 `express-validator`)。
    - [ ] 對所有接收外部輸入的路由（請求參數、請求體）添加嚴格的驗證規則。
- [ ] **任務 6.3：改進日誌記錄**
    - [ ] 引入結構化的日誌庫 (如 `winston` 或 `pino`)。
    - [ ] 除了錯誤日誌，添加關鍵操作的應用程序日誌。
- [ ] **任務 6.4：編寫單元測試和集成測試**
    - [ ] 優先為服務層的業務邏輯和數據庫訪問層的查詢編寫單元測試。
    - [ ] 為關鍵的 API 端點編寫集成測試。
- [ ] **任務 6.5：(可選) 考慮前端與後端進一步分離**
    - [ ] 評估當前 EJS 模板引擎是否滿足長期需求。
    - [ ] 如果前端邏輯複雜，研究將前端遷移到現代框架 (React, Vue, Angular) 的可行性，後端僅提供 API。

## 階段四：驗收與總結

- [ ] **任務 7.1：進行全面的回歸測試**
    - [ ] 確保所有重構後的代碼功能符合預期，沒有引入新的問題。
- [ ] **任務 7.2：代碼審查**
    - [ ] 對重構後的代碼進行內部或同行審查。
- [ ] **任務 7.3：更新專案文檔**
    - [ ] 如果有架構圖或設計文檔，進行相應更新。
- [ ] **任務 7.4：總結重構經驗並規劃後續迭代**


